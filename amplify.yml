version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - npm run build
        - echo "Build completed, checking sizes..."
        - echo "node_modules size:"
        - du -sh node_modules || echo "node_modules not found"
        - echo ".next size:"
        - du -sh .next
        - echo "Total project size:"
        - du -sh .
        - echo "Cleaning up large files..."
        - rm -rf .git
        - rm -f *.log
        - rm -f yarn.lock
        - echo "Cleaning up .next cache..."
        - rm -rf .next/cache
        - echo "Creating deployment package..."
        - mkdir -p deploy
        - cp -r .next deploy/
        - cp -r public deploy/ 2>/dev/null || echo "No public directory"
        - cp package.json deploy/
        - cp package-lock.json deploy/
        - # Amplify expects required-server-files.json at the artifact root
        - cp .next/required-server-files.json deploy/ || echo "required-server-files.json already in place"
        - # Include Next config at artifact root if present
        - if [ -f next.config.mjs ]; then cp next.config.mjs deploy/; fi
        - echo "Deployment package size:"
        - du -sh deploy
  artifacts:
    baseDirectory: deploy
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
